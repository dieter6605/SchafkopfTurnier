{% extends "layout.html" %}
{% block content %}

<style>
  .sk-row { cursor: pointer; }
  .sk-row.sk-selected { outline: 3px solid rgba(13,110,253,.35); border-radius: 10px; }
  .sk-kbd { font-size: .95rem; color: rgba(0,0,0,.55); }
</style>

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h3 class="mb-0">Turniere</h3>
    <div class="text-muted small">Übersicht aller angelegten Turniere</div>
    <div class="sk-kbd mt-1">
      Tastatur: ↑/↓ wählen · Enter öffnen · N = Neues Turnier · B = Bearbeiten · Entf = Löschen
    </div>
  </div>
  <div>
    <a class="btn btn-primary" id="btnNewTournament" href="{{ url_for('tournaments.tournament_new') }}">
      Neues Turnier
    </a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    {% if tournaments %}
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Titel</th>
              <th>Teilnehmer</th>
              <th class="text-end">Aktion</th>
            </tr>
          </thead>
          <tbody id="tBody">
            {% for t in tournaments %}
              <tr class="sk-row"
                  data-open-url="{{ url_for('tournaments.tournament_detail', tournament_id=t.id) }}"
                  data-edit-url="{{ url_for('tournaments.tournament_edit', tournament_id=t.id) }}"
                  data-delete-form-id="delForm{{ t.id }}">
                <td class="text-nowrap">
                  {{ t.event_date }}<br>
                  <span class="text-muted small">{{ t.start_time }}</span>
                </td>
                <td>
                  <strong>{{ t.title }}</strong>
                  {% if t.location %}
                    <div class="text-muted small">{{ t.location }}</div>
                  {% endif %}
                </td>
                <td>
                  {{ t.participant_count }}
                </td>
                <td class="text-end">
                  <div class="d-inline-flex gap-2 flex-wrap justify-content-end">

                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('tournaments.tournament_detail', tournament_id=t.id) }}">
                      Öffnen
                    </a>

                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('tournaments.tournament_edit', tournament_id=t.id) }}">
                      Bearbeiten
                    </a>

                    <form method="post"
                          id="delForm{{ t.id }}"
                          action="{{ url_for('tournaments.tournament_delete', tournament_id=t.id) }}"
                          class="d-inline">
                      <button class="btn btn-sm btn-outline-danger"
                              type="submit"
                              onclick="return confirm('Turnier „{{ t.title }}“ wirklich löschen?\\n\\nHinweis: Alle Teilnehmer dieses Turniers werden ebenfalls gelöscht.');">
                        Löschen
                      </button>
                    </form>

                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Noch keine Turniere angelegt.</div>
    {% endif %}

  </div>
</div>

<script>
(function () {
  let idx = -1;

  function qsa(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }
  function rows() { return qsa("#tBody tr.sk-row"); }

  function isTypingContext() {
    const el = document.activeElement;
    if (!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select";
  }

  function setSel(i) {
    const r = rows();
    if (!r.length) return;
    if (i < 0) i = 0;
    if (i >= r.length) i = r.length - 1;

    r.forEach(x => x.classList.remove("sk-selected"));
    r[i].classList.add("sk-selected");
    idx = i;
    r[i].scrollIntoView({ block: "nearest" });
  }

  function getSelRow() {
    const r = rows();
    if (!r.length) return null;
    if (idx < 0 || idx >= r.length) return null;
    return r[idx];
  }

  function openSel() {
    const row = getSelRow();
    if (!row) return;
    const url = row.dataset.openUrl;
    if (url) window.location.href = url;
  }

  function editSel() {
    const row = getSelRow();
    if (!row) return;
    const url = row.dataset.editUrl;
    if (url) window.location.href = url;
  }

  function deleteSel() {
    const row = getSelRow();
    if (!row) return;
    const formId = row.dataset.deleteFormId;
    if (!formId) return;

    const form = document.getElementById(formId);
    if (!form) return;

    // Klick auf den Button triggert confirm() aus onclick
    const btn = form.querySelector("button[type='submit']");
    if (btn) btn.click();
  }

  function wireMouse() {
    rows().forEach((row, i) => {
      row.addEventListener("mouseenter", () => setSel(i));
      row.addEventListener("click", (ev) => {
        const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
        if (tag === "a" || tag === "button" || tag === "input") return;
        setSel(i);
        openSel();
      });
    });
  }

  function onKey(ev) {
    if (ev.altKey || ev.ctrlKey || ev.metaKey) return;
    if (isTypingContext()) return;

    const k = (ev.key || "").toLowerCase();

    if (k === "n") {
      const btn = document.getElementById("btnNewTournament");
      if (btn) { ev.preventDefault(); btn.click(); }
      return;
    }

    const r = rows();
    if (!r.length) return;

    if (ev.key === "ArrowDown") { ev.preventDefault(); setSel((idx === -1) ? 0 : idx + 1); }
    else if (ev.key === "ArrowUp") { ev.preventDefault(); setSel((idx === -1) ? 0 : idx - 1); }
    else if (ev.key === "Enter") {
      ev.preventDefault();
      openSel();
    } else if (k === "b") {
      ev.preventDefault();
      editSel();
    } else if (k === "delete" || k === "backspace") {
      ev.preventDefault();
      deleteSel();
    }
  }

  function init() {
    wireMouse();
    if (rows().length) setSel(0);
    document.addEventListener("keydown", onKey);
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>

{% endblock %}