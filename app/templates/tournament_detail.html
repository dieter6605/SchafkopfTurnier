{% extends "layout.html" %}
{% block content %}

{% set next_round_no = (last_round_no + 1) if (last_round_no and last_round_no > 0) else 1 %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h3 class="mb-0">{{ t.title }}</h3>
    <div class="text-muted small">
      {{ t.event_date }} · {{ t.start_time }}
      {% if t.location %} · {{ t.location }}{% endif %}
    </div>
    <div class="text-muted small mt-1">
      Tastatur:
      <span class="fw-semibold">E</span> = Teilnehmer erfassen ·
      <span class="fw-semibold">L</span> = Turnierliste ·
      <span class="fw-semibold">B</span> = Bearbeiten ·
      <span class="fw-semibold">Shift + Entf</span> = Löschen
      <br>
      Runden:
      <span class="fw-semibold">1</span> = Runde 1 anzeigen ·
      <span class="fw-semibold">A</span> = Runde anzeigen ·
      <span class="fw-semibold">R</span> = Runde auslosen ·
      <span class="fw-semibold">N</span> = nächste Runde ·
      <span class="fw-semibold">+ / -</span> = Runde ändern
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap justify-content-end">
    <a class="btn btn-outline-secondary"
       id="btnBackToList"
       href="{{ url_for('tournaments.tournaments_list') }}">
      Turniere
    </a>

    <a class="btn btn-outline-secondary"
       id="btnEditTournament"
       href="{{ url_for('tournaments.tournament_edit', tournament_id=t.id) }}">
      Bearbeiten
    </a>

    <form method="post"
          action="{{ url_for('tournaments.tournament_delete', tournament_id=t.id) }}"
          class="d-inline">
      <button class="btn btn-outline-danger"
              id="btnDeleteTournament"
              type="submit"
              onclick="return confirm('Turnier wirklich löschen?\n\nHinweis: Alle erfassten Teilnehmer dieses Turniers werden ebenfalls gelöscht.');">
        Löschen
      </button>
    </form>

    <a class="btn btn-primary"
       id="btnParticipants"
       href="{{ url_for('tournaments.tournament_participants', tournament_id=t.id) }}">
      Teilnehmer erfassen
    </a>
  </div>
</div>

<div class="row g-3 mb-3">

  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Teilnehmer</div>
        <div style="font-size:2rem;font-weight:800;">
          {{ counts.participants }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Tische (4er)</div>
        <div style="font-size:2rem;font-weight:800;">
          {{ counts.tables }}
          {% if counts.rest %}
            <span class="text-danger">+{{ counts.rest }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Infos</div>
        <div class="small">
          {% if t.organizer %}<div><strong>Orga:</strong> {{ t.organizer }}</div>{% endif %}
          {% if t.description %}<div class="text-muted">{{ t.description }}</div>{% endif %}
          {% if not t.organizer and not t.description %}
            <div class="text-muted">–</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Runden / Auslosung -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h5 class="mb-1">Runden / Auslosung</h5>
        <div class="text-muted small">
          Auslosen überschreibt (mit Bestätigung) eine vorhandene Auslosung derselben Runde.
          {% if last_round_no and last_round_no > 0 %}
            · Letzte Runde: <strong>{{ last_round_no }}</strong>
          {% endif %}
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap justify-content-end">
        <a class="btn btn-outline-primary"
           id="btnRound1Show"
           href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=1) }}">
          Runde 1 anzeigen
        </a>

        <form method="post"
              action="{{ url_for('tournaments.tournament_round_draw', tournament_id=t.id, round_no=1) }}"
              class="d-inline"
              onsubmit="return confirm('Runde 1 auslosen?\n\nHinweis: Eine bestehende Auslosung dieser Runde wird überschrieben.');">
          <button class="btn btn-warning" id="btnRound1Draw" type="submit">
            Runde 1 auslosen
          </button>
        </form>

        <!-- ✅ Neu: nächste Runde anzeigen (letzte+1, sonst 1) -->
        <a class="btn btn-outline-primary"
           id="btnNextRoundShow"
           href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=next_round_no) }}">
          Nächste Runde ({{ next_round_no }}) anzeigen
        </a>

        {% if last_round_no and last_round_no > 0 %}
          <a class="btn btn-outline-secondary"
             id="btnLastRound"
             href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=last_round_no) }}">
            Letzte Runde anzeigen
          </a>
        {% endif %}
      </div>
    </div>

    <hr class="my-3">

    <div class="d-flex gap-2 flex-wrap align-items-center">
      <form method="get"
            id="roundShowForm"
            class="d-flex gap-2 align-items-center"
            onsubmit="
              var rn = document.getElementById('roundNo').value || '1';
              this.action = '{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=1) }}'.replace('/1', '/' + rn);
              return true;">
        <label class="text-muted small mb-0" for="roundNo">Runde</label>

        <input id="roundNo" class="form-control form-control-sm"
               type="number" min="1" step="1"
               value="{{ next_round_no }}"
               style="max-width:110px;">

        <button class="btn btn-sm btn-outline-primary" id="btnRoundShow" type="submit">Anzeigen</button>
      </form>

      <form method="post"
            id="roundDrawForm"
            class="d-flex gap-2 align-items-center"
            onsubmit="
              var rn = document.getElementById('roundNo').value || '1';
              this.action = '{{ url_for('tournaments.tournament_round_draw', tournament_id=t.id, round_no=1) }}'.replace('/1/', '/' + rn + '/');
              return confirm('Runde ' + rn + ' auslosen?\n\nHinweis: Eine bestehende Auslosung dieser Runde wird überschrieben.');">
        <button class="btn btn-sm btn-warning" id="btnRoundDraw" type="submit">Runde auslosen (überschreiben)</button>
      </form>
    </div>
  </div>
</div>

<script>
(function () {
  const lastRoundNo = {{ (last_round_no or 0) | int }};

  function isTypingContext() {
    const el = document.activeElement;
    if (!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select";
  }

  function clickIf(id) {
    const el = document.getElementById(id);
    if (el) el.click();
  }

  function getRoundNo() {
    const inp = document.getElementById("roundNo");
    const v = inp ? String(inp.value || "").trim() : "";
    const n = parseInt(v || "1", 10);
    return (isFinite(n) && n >= 1) ? n : 1;
  }

  function setRoundNo(n) {
    const inp = document.getElementById("roundNo");
    if (!inp) return;
    const nn = Math.max(1, parseInt(String(n), 10) || 1);
    inp.value = String(nn);
    inp.focus();
    try { inp.select(); } catch (e) {}
  }

  document.addEventListener("keydown", function (ev) {
    if (ev.altKey || ev.ctrlKey || ev.metaKey) return;

    const k = (ev.key || "").toLowerCase();

    if (!isTypingContext()) {
      if (k === "e") { ev.preventDefault(); clickIf("btnParticipants"); return; }
      if (k === "l") { ev.preventDefault(); clickIf("btnBackToList"); return; }
      if (k === "b") { ev.preventDefault(); clickIf("btnEditTournament"); return; }

      if (ev.shiftKey && k === "delete") {
        const btn = document.getElementById("btnDeleteTournament");
        if (btn) { ev.preventDefault(); btn.click(); }
        return;
      }
    }

    const activeId = (document.activeElement && document.activeElement.id) ? String(document.activeElement.id) : "";
    const typing = isTypingContext();
    const inRoundField = (activeId === "roundNo");

    if (!typing && k === "1") {
      ev.preventDefault();
      clickIf("btnRound1Show");
      return;
    }

    if (!typing && k === "n") {
      ev.preventDefault();
      const next = (lastRoundNo > 0) ? (lastRoundNo + 1) : 1;
      setRoundNo(next);
      return;
    }

    if ((inRoundField || !typing) && (k === "+" || ev.key === "=")) {
      ev.preventDefault();
      setRoundNo(getRoundNo() + 1);
      return;
    }
    if ((inRoundField || !typing) && (k === "-" || k === "_")) {
      ev.preventDefault();
      setRoundNo(getRoundNo() - 1);
      return;
    }

    if (!typing && k === "a") {
      ev.preventDefault();
      const btn = document.getElementById("btnRoundShow");
      if (btn) btn.click();
      return;
    }

    if (!typing && k === "r") {
      ev.preventDefault();
      const btn = document.getElementById("btnRoundDraw");
      if (btn) btn.click();
      return;
    }
  });
})();
</script>

{% endblock %}