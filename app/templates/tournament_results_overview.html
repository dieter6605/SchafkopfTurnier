<!-- app/templates/tournament_results_overview.html -->
{% extends "layout.html" %}
{% block content %}

{# --------------------------- #}
{# Status: Turnier geschlossen? #}
{# --------------------------- #}
{% set closed_at = (t.closed_at if t.closed_at is defined else (t['closed_at'] if (t is mapping and 'closed_at' in t) else None)) %}
{% set is_closed = (closed_at is not none and (closed_at|string)|length > 0) %}

<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
  <div>
    <h3 class="mb-0">{{ t.title }} â€“ Ergebnisse Runde {{ round_no }}</h3>
    <div class="text-muted small">
      Tisch auswÃ¤hlen â†’ Punkte/Soli eingeben Â· {% if now %}Stand: {{ now }}{% endif %}
    </div>

    {% if total_tables is defined %}
      <div class="text-muted small mt-1">
        Tische: <span class="fw-semibold">{{ done_count }}</span> fertig Â·
        <span class="fw-semibold">{{ open_count }}</span> offen Â·
        gesamt <span class="fw-semibold">{{ total_tables }}</span>
        {% if expected_scores is defined %}
          Â· Einzelwerte: <span class="fw-semibold">{{ scores_count }}</span>/{{ expected_scores }}
        {% endif %}
      </div>
    {% endif %}
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <a class="btn btn-outline-secondary"
       href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=round_no) }}">
      Runde
    </a>

    <a class="btn btn-outline-primary"
       href="{{ url_for('tournaments.tournament_round_results_standings', tournament_id=t.id, round_no=round_no) }}">
      Rundenwertung
    </a>

    <a class="btn btn-outline-secondary"
       href="{{ url_for('tournaments.tournament_standings_overall', tournament_id=t.id) }}">
      Gesamtwertung
    </a>
  </div>
</div>

{% if is_closed %}
  <div class="alert alert-warning d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="fw-semibold">Turnier ist abgeschlossen â€“ Ergebnis-Eingabe ist gesperrt.</div>
      <div class="small text-muted mt-1">Abgeschlossen seit: <span class="sk-mono">{{ closed_at }}</span></div>
    </div>
  </div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-body">
    {% if not table_nos %}
      <div class="text-muted">Noch keine Auslosung fÃ¼r diese Runde.</div>
    {% else %}
      <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2">
        {% for tn in table_nos %}
          {% set is_done = (tn in done_tables) %}
          <div class="col">
            <a class="btn w-100 {% if is_done %}btn-success{% else %}btn-outline-primary{% endif %}"
               href="{{ url_for('tournaments.tournament_round_results_table', tournament_id=t.id, round_no=round_no, table_no=tn) }}"
               {% if is_closed %}title="Turnier ist abgeschlossen â€“ Eingabe gesperrt (nur Ansicht)"{% endif %}>
              Tisch {{ tn }}
              {% if is_done %}âœ“{% endif %}
              {% if is_closed %}<span class="small">ðŸ”’</span>{% endif %}
            </a>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}