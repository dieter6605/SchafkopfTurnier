<!-- app/templates/tournament_participants.html -->
{# app/templates/tournament_participants.html #}
{% extends "layout.html" %}
{% block content %}

<style>
  .sk-hit { cursor:pointer; }
  .sk-selected { outline: 3px solid rgba(13,110,253,.45); border-radius: 10px; }
  .sk-kbd { font-size: .95rem; color: rgba(0,0,0,.55); }
  .sk-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* ✅ NEU: Trefferzeile deaktiviert (wenn cap erreicht oder Turnier geschlossen) */
  .sk-hit.sk-hit-disabled { cursor: not-allowed; opacity: .6; }

  /* Klick-Zeile (nur wenn editierbar) */
  .sk-part { cursor: pointer; }
  .sk-part a { text-decoration: none; }
  .sk-part a:hover { text-decoration: underline; }

  /* Swap-Modal */
  .sk-swap-item.sk-swap-picked {
    outline: 3px solid rgba(13,110,253,.35);
    border-radius: 10px;
  }

  /* Audit filter helpers */
  .sk-audit-filters .btn { white-space: nowrap; }
</style>

{% set closed_at = (t.closed_at if t.closed_at is defined else (t['closed_at'] if (t is mapping and 'closed_at' in t) else None)) %}
{% set is_closed = (closed_at is not none and (closed_at|string)|length > 0) %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h3 class="mb-0">{{ t.title }} – Teilnehmer</h3>
    <div class="text-muted small">{{ t.event_date }} · {{ t.start_time }}</div>
    <div class="sk-kbd mt-1">
      Tastatur: ↑/↓ wählen · Enter (Teilnehmerliste) = keine Aktion · Alt+N = Quick-Add öffnen · Esc = Quick-Add schließen · Shift+Entf = Teilnehmer entfernen
      {% if is_closed %}
        <br><span class="fw-semibold text-danger">Hinweis:</span> Turnier ist abgeschlossen – Änderungen sind gesperrt.
      {% endif %}
    </div>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('tournaments.tournament_detail', tournament_id=t.id) }}">Turnier</a>
</div>

{% if is_closed %}
  <div class="alert alert-warning d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="fw-semibold">Turnier ist abgeschlossen – Teilnehmerverwaltung ist gesperrt (read-only).</div>
      <div class="small text-muted mt-1">Abgeschlossen seit: <span class="sk-mono">{{ closed_at }}</span></div>
    </div>
  </div>
{% endif %}

<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Teilnehmer</div>
        <div style="font-size:2.2rem;font-weight:900;">{{ counts.participants }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small mb-1">Teilnehmernummern</div>

        <div class="d-flex gap-2 flex-wrap align-items-center">
          <form method="post"
                action="{{ url_for('tournaments.tournament_participants_check_numbers', tournament_id=t.id) }}">
            <input type="hidden" name="q" value="{{ q or '' }}">
            <button class="btn btn-sm btn-outline-secondary"
                    title="Prüft auf Lücken (Anzeige kommt als nächstes)"
                    {% if is_closed %}disabled{% endif %}>
              Prüfen
            </button>
          </form>

          <form method="post"
                action="{{ url_for('tournaments.tournament_participants_check_numbers', tournament_id=t.id) }}">
            <input type="hidden" name="q" value="{{ q or '' }}">
            <input type="hidden" name="renumber" value="1">
            <button class="btn btn-sm btn-outline-danger"
                    title="Verdichtet alle Teilnehmer auf 1..N"
                    {% if is_closed %}disabled{% endif %}>
              Neu durchnummerieren (1..N)
            </button>
          </form>

          <form method="post"
                action="{{ url_for('tournaments.tournament_participants_renumber_from', tournament_id=t.id) }}"
                class="d-flex gap-2 align-items-center">
            <input type="hidden" name="q" value="{{ q or '' }}">
            <span class="text-muted small">Ab Nr.</span>

            <input class="form-control form-control-sm sk-mono"
                   name="start_no"
                   value=""
                   inputmode="numeric"
                   pattern="[0-9]*"
                   placeholder="z.B. 17"
                   style="max-width: 110px;"
                   title="Startnummer (>=1)"
                   {% if is_closed %}disabled{% endif %}>

            <button class="btn btn-sm btn-outline-warning"
                    title="Verdichtet ab dieser Nummer, Nummern darunter bleiben unverändert"
                    onclick="return confirm({{ ('Ab dieser Nummer neu durchnummerieren?')|tojson }});"
                    {% if is_closed %}disabled{% endif %}>
              Renummerieren ab Nr.
            </button>
          </form>

          <span class="text-muted small">Beim Entfernen bleibt die Nummer frei (Lücke). Renummerieren nur über die Funktionen hier.</span>
        </div>

        {% if show_gaps %}
          <hr class="my-2">
          {% if gaps and gaps|length > 0 %}
            <div class="small">
              <span class="text-muted">Lücken (1..max):</span>
              <span class="sk-mono">{{ gaps|join(", ") }}</span>
            </div>
          {% else %}
            <div class="small text-muted">Keine Lücken gefunden.</div>
          {% endif %}
        {% endif %}

      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="mb-2">Suche im Adressbuch</h5>

    <form method="get" action="{{ url_for('tournaments.tournament_participants', tournament_id=t.id) }}"
          class="d-flex gap-2 flex-wrap align-items-center">
      <input id="qInput" class="form-control" name="q" value="{{ q or '' }}"
             placeholder="Suche (Name/Wohnort/Ort/PLZ/Telefon/Email/Straße)" style="min-width: 420px;" autofocus>
      <button class="btn btn-primary">Suchen</button>

      <button class="btn btn-outline-secondary" type="button" id="btnOpenQuickAdd"
              {% if is_closed %}disabled{% endif %}>
        Quick-Add (neu)
      </button>

      {% if cap_ok is defined and not cap_ok %}
        <span class="badge text-bg-danger">Max. Teilnehmer erreicht</span>
      {% endif %}
      {% if is_closed %}
        <span class="badge text-bg-warning">geschlossen</span>
      {% endif %}
    </form>

{% if hits %}
  <hr>
  <div class="table-responsive">
    <table class="table table-striped mb-0">
      <thead>
        <tr>
          <th>Treffer</th>
          <th class="text-end">Aktion</th>
        </tr>
      </thead>
      <tbody id="hitsBody">
        {% for h in hits %}

          {# ✅ Patch: Disabled-Logik + Reason #}
          {% set hit_disabled = (is_closed) or (cap_ok is defined and not cap_ok) %}
          {% if is_closed %}
            {% set hit_reason = "Turnier ist abgeschlossen – Übernehmen ist gesperrt." %}
          {% elif cap_ok is defined and not cap_ok %}
            {% set hit_reason = "Maximale Teilnehmerzahl erreicht – Übernehmen nicht möglich." %}
          {% else %}
            {% set hit_reason = "" %}
          {% endif %}

          <tr class="sk-hit{% if hit_disabled %} sk-hit-disabled{% endif %}"
              {% if not hit_disabled %}
                data-add-url="{{ url_for('tournaments.tournament_participant_add', tournament_id=t.id, address_id=h.id, q=q or '') }}"
              {% endif %}
              {% if hit_disabled %}
                data-disabled-reason="{{ hit_reason }}"
              {% endif %}
          >
            <td>
              <strong>{{ h.nachname }}</strong>, {{ h.vorname }}
              <span class="text-muted">· {{ h.wohnort }}</span>
              <span class="text-muted small sk-mono">#{{ h.id }}</span>
            </td>
            <td class="text-end">
              <form method="post"
                    action="{{ url_for('tournaments.tournament_participant_add', tournament_id=t.id, address_id=h.id, q=q or '') }}">
                <button class="btn btn-sm btn-outline-primary"
                        {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
                        {% if is_closed %}disabled{% endif %}>
                  Übernehmen
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  {% if q %}
    <div class="text-muted mt-2">Keine Treffer.</div>
  {% endif %}
{% endif %}
  </div>
</div>

<div class="card shadow-sm mb-3" id="quickAddCard" style="display:none;">
  <div class="card-body">
    <h5 class="mb-2">Quick-Add: neuer Teilnehmer</h5>
    <div class="text-muted small mb-2">
      Legt eine neue Adresse im <strong>Adressbuch</strong> an und übernimmt sie sofort ins Turnier.
    </div>

    <form method="post"
          action="{{ url_for('tournaments.tournament_participant_quickadd', tournament_id=t.id) }}"
          class="row g-2">
      <input type="hidden" name="q" value="{{ q or '' }}">

      <div class="col-md-3">
        <label class="form-label">Nachname *</label>
        <input class="form-control" id="qaNachname" name="nachname" required
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>
      <div class="col-md-3">
        <label class="form-label">Vorname *</label>
        <input class="form-control" name="vorname" required
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>

      <div class="col-md-3">
        <label class="form-label">Wohnort *</label>
        <input class="form-control sk-wohnort-input"
               name="wohnort" required autocomplete="off"
               data-plz-id="qaPlz"
               data-ort-id="qaOrt"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
        <div class="form-text">Autocomplete aus Wohnort-Tabelle</div>
      </div>

      <div class="col-md-3">
        <label class="form-label">Telefon</label>
        <input class="form-control" name="telefon"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>

      <div class="col-md-2">
        <label class="form-label">PLZ</label>
        <input class="form-control" id="qaPlz" name="plz"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Ort</label>
        <input class="form-control" id="qaOrt" name="ort"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Straße</label>
        <input class="form-control" name="strasse"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>
      <div class="col-md-2">
        <label class="form-label">Hausnr.</label>
        <input class="form-control" name="hausnummer"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>

      <div class="col-md-4">
        <label class="form-label">E-Mail</label>
        <input class="form-control" name="email"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>
      <div class="col-md-8">
        <label class="form-label">Notizen</label>
        <input class="form-control" name="notizen"
               {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
               {% if is_closed %}disabled{% endif %}>
      </div>

      <div class="col-12 d-flex gap-2 mt-2 flex-wrap">
        <button class="btn btn-primary" type="submit"
                {% if cap_ok is defined and not cap_ok %}disabled{% endif %}
                {% if is_closed %}disabled{% endif %}>
          Anlegen + übernehmen
        </button>
        <button class="btn btn-outline-secondary" type="button" id="btnCloseQuickAdd">Schließen</button>
      </div>

      {% if cap_ok is defined and not cap_ok %}
        <div class="col-12">
          <div class="alert alert-danger mb-0 mt-2">
            Maximale Teilnehmerzahl erreicht – Quick-Add ist deaktiviert.
          </div>
        </div>
      {% endif %}
      {% if is_closed %}
        <div class="col-12">
          <div class="alert alert-warning mb-0 mt-2">
            Turnier ist abgeschlossen – Quick-Add ist deaktiviert.
          </div>
        </div>
      {% endif %}
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-2">Erfasste Turnierteilnehmer</h5>

    {% if participants %}
      <div class="table-responsive">
        <table class="table table-striped mb-0 align-middle">
          <thead>
            <tr>
              <th style="width:90px;">Nr</th>
              <th>Name</th>
              {% if not is_closed %}
                <th class="text-end" style="width:520px;">Aktionen</th>
              {% endif %}
            </tr>
          </thead>

          <tbody id="participantsBody">
          {% for p in participants %}

            {% set _st = (p.status if p.status is defined else (p.address_status if p.address_status is defined else (p.addr_status if p.addr_status is defined else None))) %}
            {% set _locked_flag = (p.address_locked if p.address_locked is defined else (p.is_locked if p.is_locked is defined else None)) %}
            {% set addr_locked = (
                (_locked_flag is not none and _locked_flag) or
                (_st is not none and (_st|string)|lower in ['gesperrt','locked','inactive','inaktiv','deaktiviert','archiviert'])
            ) %}

            {% set can_edit = (not is_closed) and (not addr_locked) %}

            <tr id="tp{{ p.id }}" class="{% if can_edit %}sk-part{% endif %}" data-delete-form-id="rmForm{{ p.id }}">
              <td class="sk-mono">
                {% if can_edit %}
                  <a href="{{ url_for('addresses.address_edit', address_id=p.address_id, next=(request.full_path ~ '#tp' ~ p.id)) }}"
                     title="Teilnehmer bearbeiten">
                    <strong>{{ p.player_no }}</strong>
                  </a>
                {% else %}
                  <strong>{{ p.player_no }}</strong>
                {% endif %}
              </td>

              <td>
                {% if can_edit %}
                  <a href="{{ url_for('addresses.address_edit', address_id=p.address_id, next=(request.full_path ~ '#tp' ~ p.id)) }}"
                     title="Teilnehmer bearbeiten">
                    <strong>{{ p.nachname }}</strong>, {{ p.vorname }}
                  </a>
                {% else %}
                  <strong>{{ p.nachname }}</strong>, {{ p.vorname }}
                {% endif %}

                <span class="text-muted">· {{ p.wohnort }}</span>

                <div class="text-muted small">
                  <span class="sk-mono">#{{ p.address_id }}</span>
                  {% if p.email %} · ✉ {{ p.email }}{% endif %}
                  {% if addr_locked %}
                    · <span class="badge text-bg-secondary" title="Adresse ist gesperrt – Bearbeiten ausgeblendet">Adresse gesperrt</span>
                  {% endif %}
                </div>
              </td>

              {% if not is_closed %}
              <td class="text-end">
                <div class="d-flex justify-content-end gap-2 flex-wrap">

                  {% if not addr_locked %}
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('addresses.address_edit', address_id=p.address_id, next=(request.full_path ~ '#tp' ~ p.id)) }}"
                       title="Adressmaske öffnen">
                      Bearbeiten
                    </a>
                  {% endif %}

                  <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-skt-swap-open="1"
                          data-tp-id="{{ p.id }}"
                          data-player-no="{{ p.player_no }}"
                          data-current-address-id="{{ p.address_id }}"
                          data-current-label="{{ p.nachname }}, {{ p.vorname }} · {{ p.wohnort }}"
                          title="Ersetzt oder tauscht Teilnehmer (Nummer bleibt gleich)">
                    Swap…
                  </button>

                  <form method="post"
                        id="rmForm{{ p.id }}"
                        action="{{ url_for('tournaments.tournament_participant_remove', tournament_id=t.id, tp_id=p.id) }}">
                    <input type="hidden" name="q" value="{{ q or '' }}">
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="return confirm({{
                              ('Teilnehmer Nr ' ~ p.player_no ~ ' entfernen?\n\nHinweis: Die Nummer bleibt als Lücke frei.')|tojson
                            }});"
                            title="Entfernt, Nummer bleibt frei (keine automatische Renummerierung)">
                      Entfernen
                    </button>
                  </form>

                </div>
              </td>
              {% endif %}
            </tr>

          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Noch keine Teilnehmer erfasst.</div>
    {% endif %}
  </div>
</div>

<!-- =========================================================
     ✅ Audit-Log (Variante B): Accordion direkt auf der Seite
========================================================== -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="accordion" id="auditAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="auditHead">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse" data-bs-target="#auditCollapse"
                  aria-expanded="false" aria-controls="auditCollapse">
            Änderungsverlauf (Audit-Log)
            <span class="ms-2 badge text-bg-secondary">
              {{ (audit|length) if audit is defined and audit else 0 }}
            </span>
          </button>
        </h2>
        <div id="auditCollapse" class="accordion-collapse collapse" aria-labelledby="auditHead"
             data-bs-parent="#auditAccordion">
          <div class="accordion-body">

            {% if audit is defined and audit and audit|length > 0 %}

              <!-- ✅ Filter/Toggle -->
              <div class="d-flex flex-wrap gap-2 align-items-center mb-2 sk-audit-filters">
                <div class="btn-group btn-group-sm" role="group" aria-label="Audit Filter">
                  <button type="button" class="btn btn-outline-secondary" data-audit-filter="all">Alle</button>
                  <button type="button" class="btn btn-outline-secondary" data-audit-filter="swap">nur Swap</button>
                  <button type="button" class="btn btn-outline-secondary" data-audit-filter="remove">nur Entfernen</button>
                  <button type="button" class="btn btn-outline-secondary" data-audit-filter="today">nur heute</button>
                </div>

                <div class="input-group input-group-sm" style="max-width: 320px;">
                  <span class="input-group-text">Suche</span>
                  <input type="text" class="form-control" id="auditSearchInput" placeholder="Name, #ID, tp, …">
                  <button class="btn btn-outline-secondary" type="button" id="auditSearchClear">×</button>
                </div>

                <span class="text-muted small" id="auditShownHint"></span>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0" id="auditTable">
                  <thead>
                    <tr>
                      <th style="width:170px;">Zeit</th>
                      <th style="width:160px;">Aktion</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for a in audit %}
                      {% set act = (a.action if a.action is defined else (a['action'] if (a is mapping and 'action' in a) else '')) %}
                      {% set ts = (a.created_at if a.created_at is defined else (a['created_at'] if (a is mapping and 'created_at' in a) else '')) %}
                      {% set note = (a.note if a.note is defined else (a['note'] if (a is mapping and 'note' in a) else '')) %}

                      {% set tp1 = (a.tp_id if a.tp_id is defined else (a['tp_id'] if (a is mapping and 'tp_id' in a) else None)) %}
                      {% set tp2 = (a.tp_id_2 if a.tp_id_2 is defined else (a['tp_id_2'] if (a is mapping and 'tp_id_2' in a) else None)) %}

                      {% set ao = (a.address_id_old if a.address_id_old is defined else (a['address_id_old'] if (a is mapping and 'address_id_old' in a) else None)) %}
                      {% set an = (a.address_id_new if a.address_id_new is defined else (a['address_id_new'] if (a is mapping and 'address_id_new' in a) else None)) %}
                      {% set ao2 = (a.address_id_old_2 if a.address_id_old_2 is defined else (a['address_id_old_2'] if (a is mapping and 'address_id_old_2' in a) else None)) %}
                      {% set an2 = (a.address_id_new_2 if a.address_id_new_2 is defined else (a['address_id_new_2'] if (a is mapping and 'address_id_new_2' in a) else None)) %}

                      <tr
                        data-audit-action="{{ act }}"
                        data-audit-ts="{{ ts }}"
                      >
                        <td class="sk-mono small">{{ ts }}</td>

                        <!-- ✅ Patch Nr. 2: Action-Badge als Label -->
                        <td class="small">
                          {% set label = {
                            'swap_exchange':'Tausch',
                            'swap_replace':'Ersetzen',
                            'add':'Hinzufügen',
                            'quickadd':'Quick-Add',
                            'edit':'Bearbeiten',
                            'remove':'Entfernen'
                          }.get(act, act) %}
                          <span class="badge text-bg-light border">{{ label }}</span>
                        </td>

                        <!-- ✅ Patch Nr. 1: Details-Mapping -->
                        <td class="small">
                          {% if act == 'swap_exchange' %}
                            <div class="sk-mono">
                              Tausch: tp {{ tp1 }} ↔ tp {{ tp2 }}
                              · #{{ ao }} ⇄ #{{ an }}
                              {% if ao2 or an2 %}
                                · (#{{ ao2 }} ⇄ #{{ an2 }})
                              {% endif %}
                            </div>

                          {% elif act == 'swap_replace' %}
                            <div class="sk-mono">
                              Ersetzen: tp {{ tp1 }} · #{{ ao }} → #{{ an }}
                            </div>

                          {% elif act == 'add' %}
                            <div class="sk-mono">
                              Hinzufügen: tp {{ tp1 }} · #{{ an }}
                            </div>

                          {% elif act == 'quickadd' %}
                            <div class="sk-mono">
                              Quick-Add: tp {{ tp1 }} · #{{ an }}
                            </div>

                          {% elif act == 'edit' %}
                            <div class="sk-mono">
                              Bearbeiten: {% if tp1 %}tp {{ tp1 }}{% endif %}
                              {% if an %} · #{{ an }}{% endif %}
                              {% if ao and (ao != an) %} (alt #{{ ao }}){% endif %}
                            </div>

                          {% elif act == 'remove' %}
                            <div class="sk-mono">
                              Entfernen: tp {{ tp1 }}{% if ao %} · alt #{{ ao }}{% endif %}
                            </div>

                          {% else %}
                            <div class="sk-mono">
                              {{ act }}{% if tp1 %} · tp {{ tp1 }}{% endif %}{% if tp2 %} / tp2 {{ tp2 }}{% endif %}
                              {% if ao or an %} · #{{ ao }} → #{{ an }}{% endif %}
                            </div>
                          {% endif %}

                          {% if note %}
                            <div class="text-muted mt-1">{{ note }}</div>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="form-text mt-2">
                Es werden die letzten 200 Einträge angezeigt.
              </div>
            {% else %}
              <div class="text-muted">Noch keine Änderungen protokolliert.</div>
            {% endif %}

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if not is_closed %}
<div class="modal fade" id="sktSwapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Teilnehmer ersetzen / tauschen (Swap)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info py-2">
          <div class="small">
            <strong>Aktueller Teilnehmer</strong> (Nr <span class="sk-mono" id="sktSwapPlayerNo">—</span>):
            <span id="sktSwapCurrent">—</span>
          </div>
          <div class="small mt-1">
            <strong>Neu</strong>: <span id="sktSwapPickedLabel">—</span>
            <span class="text-muted" id="sktSwapPickedMode"></span>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label">Suche (im Dialog)</label>
          <input id="sktSwapQuery" class="form-control"
                 placeholder="Mind. 2 Zeichen: Name, Wohnort, PLZ, Telefon, E-Mail …">
          <div class="form-text">
            Tipp: Treffer, die bereits Teilnehmer sind, werden als „im Turnier“ angezeigt (→ Tauschen).
          </div>
        </div>

        <div class="border rounded p-2" style="max-height: 340px; overflow:auto;">
          <div id="sktSwapHint" class="text-muted small">
            Suche starten: mind. 2 Zeichen eingeben.
          </div>
          <div class="list-group" id="sktSwapList"></div>
        </div>

        <form id="sktSwapForm" method="post"
              action="{{ url_for('tournaments.tournament_participant_swap', tournament_id=t.id) }}">
          <input type="hidden" name="q" value="{{ q or '' }}">
          <input type="hidden" name="tp_id" id="sktSwapTpId" value="">
          <input type="hidden" name="new_address_id" id="sktSwapNewAddressId" value="">
          <input type="hidden" name="next" id="sktSwapNext" value="">
        </form>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" id="sktSwapSubmitBtn">Swap ausführen</button>
      </div>

    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  window.__SKT_TOURNAMENT_CLOSED__ = {{ 1 if is_closed else 0 }};
</script>

{% if not is_closed %}
<script>
(function () {
  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  function debounce(fn, ms) {
    let t = null;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), ms);
    };
  }

  function wireSwapOpenButtons() {
    const btns = qsa("[data-skt-swap-open='1']");
    if (!btns.length) return;

    const modalEl = qs("#sktSwapModal");
    if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) return;
    const modal = new window.bootstrap.Modal(modalEl);

    const tpIdEl = qs("#sktSwapTpId");
    const newIdEl = qs("#sktSwapNewAddressId");
    const nextEl = qs("#sktSwapNext");
    const pnoEl = qs("#sktSwapPlayerNo");
    const curEl = qs("#sktSwapCurrent");
    const pickedLabelEl = qs("#sktSwapPickedLabel");
    const pickedModeEl = qs("#sktSwapPickedMode");
    const queryEl = qs("#sktSwapQuery");
    const listEl = qs("#sktSwapList");
    const hintEl = qs("#sktSwapHint");
    const submitBtn = qs("#sktSwapSubmitBtn");

    const API_URL_BASE = "{{ url_for('tournaments.tournament_participants_swap_search', tournament_id=t.id) }}";

    function clearPicked() {
      if (newIdEl) newIdEl.value = "";
      if (pickedLabelEl) pickedLabelEl.textContent = "—";
      if (pickedModeEl) pickedModeEl.textContent = "";
      qsa("#sktSwapList .sk-swap-picked").forEach(x => x.classList.remove("sk-swap-picked"));
    }

    function itemLabel(it) {
      const nn = String(it.nachname || "").trim();
      const vn = String(it.vorname || "").trim();
      const wo = String(it.wohnort || "").trim();
      const name = (nn && vn) ? (nn + ", " + vn) : (nn || vn || "");
      return (name ? (name + (wo ? (" · " + wo) : "")) : (wo || ("#" + String(it.id || ""))));
    }

    function renderItems(items, currentAddressId) {
      if (!listEl) return;
      listEl.innerHTML = "";

      if (!items || !items.length) {
        if (hintEl) hintEl.textContent = "Keine Treffer.";
        return;
      }
      if (hintEl) hintEl.textContent = "";

      items.forEach((it) => {
        const aid = String(it.id || "");
        const label = itemLabel(it);
        const inTour = !!it.in_tournament;
        const pno = (it.player_no != null) ? String(it.player_no) : "";
        const isSame = (String(currentAddressId) === aid);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "list-group-item list-group-item-action sk-swap-item";
        btn.dataset.addressId = aid;
        btn.dataset.addressLabel = label;
        btn.dataset.inTournament = inTour ? "1" : "0";
        btn.dataset.playerNo = pno || "";
        btn.disabled = isSame;

        btn.innerHTML = `
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div>${label} <span class="text-muted small sk-mono">#${aid}</span></div>
              ${
                inTour
                  ? `<div class="small text-muted">bereits Teilnehmer ${pno ? `(Nr ${pno})` : ""}</div>`
                  : `<div class="small text-muted">nur Adressbuch</div>`
              }
              ${isSame ? `<div class="small text-danger">ist bereits die aktuelle Person</div>` : ``}
            </div>
            <div>
              ${inTour ? `<span class="badge text-bg-success">im Turnier</span>` : `<span class="badge text-bg-secondary">Adressbuch</span>`}
            </div>
          </div>
        `;
        listEl.appendChild(btn);
      });
    }

    async function fetchSwap(q, currentAddressId) {
      const qq = String(q || "").trim();
      if (!qq || qq.length < 2) {
        if (listEl) listEl.innerHTML = "";
        if (hintEl) hintEl.textContent = "Suche starten: mind. 2 Zeichen eingeben.";
        return;
      }

      if (hintEl) hintEl.textContent = "Suche…";

      try {
        const url = API_URL_BASE + "?q=" + encodeURIComponent(qq) + "&limit=30";
        const resp = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!resp.ok) {
          if (hintEl) hintEl.textContent = "Suche fehlgeschlagen.";
          return;
        }
        const data = await resp.json();
        if (!data || data.ok !== true) {
          if (hintEl) hintEl.textContent = "Suche fehlgeschlagen.";
          return;
        }
        renderItems(data.items || [], currentAddressId);
      } catch (e) {
        if (hintEl) hintEl.textContent = "Suche fehlgeschlagen.";
      }
    }

    const fetchDebounced = debounce(fetchSwap, 250);

    modalEl.addEventListener("click", function (ev) {
      const tgt = ev.target?.closest?.(".sk-swap-item");
      if (!tgt) return;

      const aid = tgt.dataset.addressId;
      const label = tgt.dataset.addressLabel || ("Adresse #" + aid);
      const inTour = tgt.dataset.inTournament === "1";
      const pno = tgt.dataset.playerNo || "";

      if (!aid) return;

      qsa("#sktSwapList .sk-swap-item").forEach(x => x.classList.remove("sk-swap-picked"));
      tgt.classList.add("sk-swap-picked");

      if (newIdEl) newIdEl.value = aid;
      if (pickedLabelEl) pickedLabelEl.textContent = label;

      if (pickedModeEl) {
        pickedModeEl.textContent = inTour ? (" (Tauschen" + (pno ? (" mit Nr " + pno) : "") + ")") : " (Ersetzen)";
      }
    });

    if (submitBtn) {
      submitBtn.addEventListener("click", function () {
        const tpId = String(tpIdEl?.value || "").trim();
        const newId = String(newIdEl?.value || "").trim();
        const pno = String(pnoEl?.textContent || "").trim();
        const picked = String(pickedLabelEl?.textContent || "").trim();

        const pickedRow = qs("#sktSwapList .sk-swap-item.sk-swap-picked");
        const inTour = pickedRow ? (pickedRow.dataset.inTournament === "1") : false;
        const otherPno = pickedRow ? (pickedRow.dataset.playerNo || "") : "";

        if (!tpId) {
          window.SKT?.toast?.("Swap: Interner Fehler (tp_id fehlt).");
          return;
        }
        if (!newId) {
          window.SKT?.toast?.("Swap: Bitte zuerst eine Zieladresse auswählen.");
          return;
        }

        const actionText = inTour ? ("TAUSCHEN" + (otherPno ? (" (mit Nr " + otherPno + ")") : "")) : "ERSETZEN";

        const ok = confirm(
          actionText + "?\n\nTeilnehmer Nr " + (pno || "?") + "\nNeu: " + (picked || ("#" + newId))
        );
        if (!ok) return;

        const form = qs("#sktSwapForm");
        if (form) form.submit();
      });
    }

    modalEl.addEventListener("show.bs.modal", function () {
      clearPicked();
      if (listEl) listEl.innerHTML = "";
      if (hintEl) hintEl.textContent = "Suche starten: mind. 2 Zeichen eingeben.";
      if (queryEl) queryEl.value = "";
      setTimeout(() => queryEl?.focus?.(), 150);
    });

    if (queryEl) {
      queryEl.addEventListener("input", function () {
        const curAddr = modalEl.dataset.currentAddressId || "";
        fetchDebounced(queryEl.value, curAddr);
      });
    }

    btns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const tpId = btn.dataset.tpId || "";
        const pno = btn.dataset.playerNo || "";
        const current = btn.dataset.currentLabel || ("#" + (btn.dataset.currentAddressId || ""));
        const curAddrId = btn.dataset.currentAddressId || "";

        if (tpIdEl) tpIdEl.value = tpId;
        if (pnoEl) pnoEl.textContent = pno || "—";
        if (curEl) curEl.textContent = current || "—";
        if (nextEl) nextEl.value = (location.pathname + location.search + "#tp" + tpId);

        modalEl.dataset.currentAddressId = curAddrId;

        modal.show();
      });
    });
  }

  function init() { wireSwapOpenButtons(); }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init, { once: true });
  } else {
    init();
  }
})();
</script>
{% endif %}

<!-- ✅ Audit Filter/Toggle JS -->
<script>
(function () {
  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  function parseDatePrefix(ts) {
    // Erwartet "YYYY-MM-DD ..." oder "YYYY-MM-DDTHH:MM:SS"
    if (!ts) return "";
    return String(ts).slice(0, 10);
  }

  function initAuditFilters() {
    const table = qs("#auditTable");
    if (!table) return;

    const rows = qsa("tbody tr", table);
    const btns = qsa("[data-audit-filter]");
    const searchEl = qs("#auditSearchInput");
    const clearBtn = qs("#auditSearchClear");
    const hintEl = qs("#auditShownHint");

    const today = (new Date()).toISOString().slice(0, 10);

    let currentFilter = "all";
    let search = "";

    function setActiveButton(val) {
      btns.forEach(b => b.classList.toggle("active", b.dataset.auditFilter === val));
    }

    function matchesFilter(row) {
      const act = (row.dataset.auditAction || "");
      const ts = (row.dataset.auditTs || "");
      if (currentFilter === "all") return true;
      if (currentFilter === "swap") return (act === "swap_exchange" || act === "swap_replace");
      if (currentFilter === "remove") return (act === "remove");
      if (currentFilter === "today") return parseDatePrefix(ts) === today;
      return true;
    }

    function matchesSearch(row) {
      const q = (search || "").trim().toLowerCase();
      if (!q) return true;
      const txt = row.textContent || "";
      return txt.toLowerCase().includes(q);
    }

    function apply() {
      let shown = 0;
      rows.forEach(r => {
        const ok = matchesFilter(r) && matchesSearch(r);
        r.style.display = ok ? "" : "none";
        if (ok) shown += 1;
      });
      if (hintEl) hintEl.textContent = shown + " / " + rows.length + " sichtbar";
    }

    btns.forEach(b => {
      b.addEventListener("click", function () {
        currentFilter = b.dataset.auditFilter || "all";
        setActiveButton(currentFilter);
        apply();
      });
    });

    if (searchEl) {
      searchEl.addEventListener("input", function () {
        search = searchEl.value || "";
        apply();
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        if (searchEl) searchEl.value = "";
        search = "";
        apply();
        searchEl?.focus?.();
      });
    }

    // default
    setActiveButton("all");
    apply();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAuditFilters, { once: true });
  } else {
    initAuditFilters();
  }
})();
</script>

<script defer src="{{ url_for('static', filename='js/participants_keys.js') }}"></script>
{% endblock %}