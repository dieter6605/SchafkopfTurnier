<!-- app/templates/tournament_round.html -->
{# app/templates/tournament_round.html #}
{% extends "layout.html" %}
{% block content %}

<style>
  .sk-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .sk-kbd  { font-size: .95rem; color: rgba(0,0,0,.55); }

  /* ---------- Screen: CSS Grid für Tische ---------- */
  .sk-table-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 1rem;
    align-items: start;
  }

  /* Accordion optisch kompakter */
  .sk-acc .accordion-button {
    padding: .6rem .85rem;
  }
  .sk-acc .accordion-body {
    padding: .75rem .85rem;
  }
  .sk-acc .accordion-button .sk-acc-title {
    font-weight: 700;
  }

  /* ✅ Header-Link (Tischname) sauber klickbar + Feinschliff */
  .sk-acc .accordion-button .sk-acc-title a {
    color: inherit;
    text-decoration: none;
  }
  .sk-acc .accordion-button .sk-acc-title a:hover {
    text-decoration: underline;
  }

  /* ✅ Fertig-Header grün */
  .sk-acc .accordion-button.sk-done {
    background: var(--bs-success);
    color: #fff;
  }
  /* Chevron im grünen Header sichtbar machen */
  .sk-acc .accordion-button.sk-done::after {
    filter: invert(1) grayscale(1) brightness(2);
  }

  /* Tabellen in Accordion etwas kompakter */
  .sk-acc table.table {
    margin-bottom: 0;
  }

  /* Kleine Metazeile für Seed/Attempt */
  .sk-drawmeta {
    margin-top: .35rem;
    font-size: .85rem;
    color: rgba(0,0,0,.55);
  }
  .sk-drawmeta .badge {
    font-weight: 700;
  }

  @media print {
    .no-break { break-inside: avoid; page-break-inside: avoid; }

    @page { margin: 12mm 12mm 18mm 12mm; }

    /* Hinweis: Page-Counter-Regeln werden nicht von allen Browsern unterstützt */
    @page {
      @bottom-right {
        content: "Seite " counter(page) " von " counter(pages);
        font-size: 10pt;
        font-weight: 600;
      }
    }

    .sk-print-columns {
      column-count: 2;
      column-gap: 10mm;
      column-fill: auto;
    }

    .sk-print-title { margin: 0 0 6mm 0; color: #000; }
    .sk-print-title .headline {
      font-size: 24pt;
      font-weight: 900;
      margin: 0;
      color: #000;
    }
    .sk-print-title .round {
      font-size: 22pt;
      font-weight: 900;
      margin: 1mm 0 2mm 0;
      color: #000;
    }
    .sk-print-title .title {
      font-size: 14pt;
      font-weight: 700;
      margin: 0 0 6mm 0;
      color: #000;
    }

    .sk-print-line {
      break-inside: avoid;
      -webkit-column-break-inside: avoid;

      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6mm;

      font-size: 13.5pt;
      line-height: 1.25;
      padding: 1.6mm 0;
      border-bottom: 1.5px solid #000;
    }

    .sk-print-left {
      flex: 1 1 auto;
      min-width: 0;
      color: #000;
    }

    .sk-print-right {
      flex: 0 0 auto;
      white-space: nowrap;
      font-weight: 900;
      color: #000;
    }

    .sk-print-muted { color: #000; font-weight: 400; }
    .sk-print-pno { font-weight: 900; color: #000; }
  }
</style>

{# --- Turnier geschlossen? (robust für sqlite Row + dict) --- #}
{% set closed_at = (t.closed_at if t.closed_at is defined else (t['closed_at'] if (t is mapping and 'closed_at' in t) else None)) %}
{% set is_closed = (closed_at is not none and (closed_at|string)|trim|length > 0) %}
{% set _closed_at_str = ((closed_at|string)|trim) if is_closed else '' %}

{# --- Draw-Status (robust) --- #}
{% set current_drawn = (seats is defined and seats and (seats|length > 0)) %}
{% set _rn = (round_no|default(0))|int %}
{% set _last_rn = (last_round_no|default(0))|int %}
{% set allow_draw_next = (current_drawn and (_rn == _last_rn)) %}

{# --- ✅ NEU: draw_seed / draw_attempt robust aus Context --- #}
{% set _draw_seed = (draw_seed if draw_seed is defined else None) %}
{% set _draw_attempt = (draw_attempt if draw_attempt is defined else 0) %}
{% set _draw_attempt_int = (_draw_attempt|default(0))|int %}
{% set _draw_seed_str = ((_draw_seed|string)|trim) if _draw_seed is not none else '' %}
{% set _has_drawmeta = (current_drawn and (_draw_attempt_int > 0 or (_draw_seed_str|length > 0))) %}

{% if is_closed %}
  <div class="alert alert-warning d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="fw-semibold">Turnier ist abgeschlossen – Änderungen sind gesperrt.</div>
      <div class="small text-muted mt-1">Abgeschlossen seit: <span class="sk-mono">{{ _closed_at_str }}</span></div>
    </div>
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2 no-print">
  <div>
    <h3 class="mb-0">{{ t.title }} – Runde {{ round_no }}</h3>
    <div class="text-muted small">{{ t.event_date }} · {{ t.start_time }}</div>

    <div class="text-muted small mt-1">
      Sitzplätze: A–D · Tische: fortlaufend
    </div>

    {# ✅ NEU: Meta-Anzeige für Auslosung # / Seed #}
    {% if _has_drawmeta %}
      <div class="sk-drawmeta">
        <span class="badge text-bg-secondary">Auslosung #{{ _draw_attempt_int }}</span>
        {% if _draw_seed_str|length > 0 %}
          <span class="ms-2">Seed: <span class="sk-mono">{{ _draw_seed_str }}</span></span>
        {% endif %}
      </div>
    {% endif %}

    <div class="sk-kbd mt-1">
      Tastatur:
      <span class="fw-semibold">T</span> = Turnier ·
      <span class="fw-semibold">R</span> = Runde auslosen/neu auslosen ·
      <span class="fw-semibold">Shift+R</span> =
      {% if current_drawn and allow_draw_next %}
        nächste Runde auslosen
      {% else %}
        diese Runde auslosen
      {% endif %}
      ·
      <span class="fw-semibold">P</span>/<span class="fw-semibold">N</span> = Vor/Zurück ·
      <span class="fw-semibold">←/→</span> = Vor/Zurück ·
      <span class="fw-semibold">Esc</span> = Turnier ·
      <span class="fw-semibold">L</span> = Letzte Runde
      <br>
      Workflow:
      <span class="fw-semibold">→</span>/<span class="fw-semibold">N</span> nutzt „Vorbereiten“, wenn „Nächste“ nicht existiert
      {% if current_drawn and (not allow_draw_next) %}
        <br>
        Hinweis: „Nächste Runde auslosen“ nur aus der <span class="fw-semibold">letzten</span> ausgelosten Runde heraus möglich.
      {% endif %}
      {% if is_closed %}
        <br>
        <span class="fw-semibold text-danger">Hinweis:</span> Turnier ist abgeschlossen – Auslosen/Ändern gesperrt.
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap justify-content-end">
    <a class="btn btn-outline-secondary"
       id="btnBackTournament"
       href="{{ url_for('tournaments.tournament_detail', tournament_id=t.id) }}">
      Turnier
    </a>

    <button class="btn btn-outline-secondary"
            type="button"
            onclick="window.print()">
      Drucken
    </button>

    {% if current_drawn %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('tournaments.tournament_round_tablesheets_docx_merged',
                          tournament_id=t.id,
                          round_no=round_no) }}">
        Tischblätter (DOCX)
      </a>

      <a class="btn btn-outline-primary"
         href="{{ url_for('tournaments.tournament_round_tablesheets_docx_zip',
                          tournament_id=t.id,
                          round_no=round_no) }}">
        Tischblätter (ZIP)
      </a>

      <a class="btn btn-outline-primary"
         href="{{ url_for('tournaments.tournament_round_results_overview', tournament_id=t.id, round_no=round_no) }}">
        Ergebnisseingabe
      </a>

      <a class="btn btn-outline-primary"
         href="{{ url_for('tournaments.tournament_round_results_standings', tournament_id=t.id, round_no=round_no) }}">
        Rundenwertung
      </a>
    {% endif %}

    <a class="btn btn-outline-secondary"
       href="{{ url_for('tournaments.tournament_standings_overall', tournament_id=t.id) }}">
      Gesamtwertung
    </a>

    {# ✅ Tooltiptext robust + aussagekräftig #}
    {% set _redraw_title = (
      "Neu auslosen erhöht die Auslosungsnummer (Attempt) und erzeugt einen neuen Seed.\n"
      "Damit entsteht eine andere, aber weiterhin deterministische Auslosung."
    ) %}

    <form method="post"
          id="formDraw"
          action="{{ url_for('tournaments.tournament_round_draw', tournament_id=t.id, round_no=round_no) }}"
          class="d-inline"
          {% if not is_closed %}
          onsubmit="return confirm({{ ('Runde ' ~ round_no ~ ' auslosen?\n\nHinweis: Eine bestehende Auslosung dieser Runde wird überschrieben.')|tojson }});"
          {% endif %}>
      <button class="btn btn-warning"
              id="btnRedraw"
              type="submit"
              title="{{ _redraw_title }}"
              {% if is_closed %}disabled aria-disabled="true"{% endif %}>
        {% if current_drawn %}
          Runde {{ round_no }} neu auslosen
          {% if _draw_attempt_int > 0 %}
            (Auslosung #{{ _draw_attempt_int + 1 }})
          {% endif %}
        {% else %}
          Runde {{ round_no }} auslosen
        {% endif %}
      </button>
    </form>

    {% if prev_round_no %}
      <a class="btn btn-outline-secondary"
         id="btnPrevRound"
         href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=prev_round_no) }}">
        Vorherige
      </a>
    {% else %}
      <a class="btn btn-outline-secondary disabled"
         id="btnPrevRound"
         href="#"
         aria-disabled="true"
         tabindex="-1">
        Vorherige
      </a>
    {% endif %}

    {% if next_round_no %}
      <a class="btn btn-outline-secondary"
         id="btnNextRound"
         href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=next_round_no) }}">
        Nächste
      </a>
    {% else %}
      <a class="btn btn-outline-secondary disabled"
         id="btnNextRound"
         href="#"
         aria-disabled="true"
         tabindex="-1">
        Nächste
      </a>
    {% endif %}

    <a class="btn btn-outline-primary"
       id="btnPrepareNext"
       href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=(round_no + 1)) }}">
      Runde {{ round_no + 1 }} vorbereiten
    </a>

    {% if allow_draw_next %}
      <form method="post"
            id="formDrawNext"
            action="{{ url_for('tournaments.tournament_round_draw', tournament_id=t.id, round_no=(round_no + 1)) }}"
            class="d-inline"
            {% if not is_closed %}
            onsubmit="return confirm({{ ('Runde ' ~ (round_no + 1) ~ ' auslosen?\n\nHinweis: Eine bestehende Auslosung dieser Runde wird überschrieben.')|tojson }});"
            {% endif %}>
        <button class="btn btn-outline-warning" id="btnDrawNext" type="submit"
                {% if is_closed %}disabled aria-disabled="true"{% endif %}>
          Runde {{ round_no + 1 }} auslosen
        </button>
      </form>
    {% elif current_drawn %}
      <button class="btn btn-outline-warning disabled"
              id="btnDrawNext"
              type="button"
              aria-disabled="true"
              tabindex="-1"
              title="Nur aus der letzten ausgelosten Runde heraus möglich.">
        Runde {{ round_no + 1 }} auslosen
      </button>
    {% endif %}

    {% if last_round_no and last_round_no > 0 %}
      <a class="btn btn-outline-secondary"
         id="btnLastRound"
         href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=last_round_no) }}">
        Letzte Runde ({{ last_round_no }})
      </a>
    {% endif %}
  </div>
</div>

{% if current_drawn %}

  <!-- ✅ Screen: CSS Grid + einklappbare Tischkarten (fertige = grün + eingeklappt) -->
  <div class="sk-table-grid no-print">
    {% for grp in seats|groupby('table_no') %}
      {% set table_no = grp.grouper %}
      {% set rows = grp.list %}

      {% set is_done = (done_tables is defined and (table_no in done_tables)) %}

      {% set acc_id = "accTable_" ~ round_no ~ "_" ~ table_no %}
      {% set col_id = "colTable_" ~ round_no ~ "_" ~ table_no %}

      <div class="accordion sk-acc no-break" id="{{ acc_id }}">
        <div class="accordion-item shadow-sm">
          <h2 class="accordion-header" id="{{ acc_id }}_h">
            <button class="accordion-button {% if is_done %}collapsed sk-done{% endif %}"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#{{ col_id }}"
                    aria-expanded="{{ 'false' if is_done else 'true' }}"
                    aria-controls="{{ col_id }}">
              <div class="d-flex justify-content-between align-items-center w-100 pe-2">
                <div class="sk-acc-title">
                  <a href="{{ url_for(
                              'tournaments.tournament_round_results_table',
                              tournament_id=t.id,
                              round_no=round_no,
                              table_no=table_no
                            ) }}"
                     title="Ergebnisse für Tisch {{ table_no }} eingeben"
                     onclick="event.stopPropagation();">
                    Tisch {{ table_no }} <span class="text-muted">→</span>
                  </a>
                  {% if is_done %}<span class="ms-2">✓</span>{% endif %}
                </div>
                <div class="small sk-mono {% if is_done %}text-white-50{% else %}text-muted{% endif %}">
                  R{{ round_no }}
                </div>
              </div>
            </button>
          </h2>

          <div id="{{ col_id }}"
               class="accordion-collapse collapse {% if not is_done %}show{% endif %}"
               aria-labelledby="{{ acc_id }}_h">
            <div class="accordion-body">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th style="width:60px;">Platz</th>
                      <th style="width:70px;">Nr</th>
                      <th>Name</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in rows %}
                      <tr>
                        <td class="sk-mono"><strong>{{ r.seat }}</strong></td>
                        <td class="sk-mono">{{ r.player_no }}</td>
                        <td>
                          <strong>{{ r.nachname }}</strong>, {{ r.vorname }}
                          <span class="text-muted">· {{ r.wohnort }}</span>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>

  {% if reserve and reserve|length > 0 %}
    <div class="card shadow-sm mt-3 no-print">
      <div class="card-body">
        <h5 class="mb-2">Reserve (nicht gesetzt)</h5>
        <div class="text-muted small mb-2">
          Teilnehmer, die nicht in einen vollen 4er Tisch gepasst haben.
        </div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th style="width:90px;">Nr</th>
                <th>Name</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reserve %}
                <tr>
                  <td class="sk-mono"><strong>{{ r.player_no }}</strong></td>
                  <td>
                    <strong>{{ r.nachname }}</strong>, {{ r.vorname }}
                    <span class="text-muted">· {{ r.wohnort }}</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="print-only">
    <div class="sk-print-title">
      <div class="headline">Alphabetischer Sitzplan</div>
      <div class="round">Runde {{ round_no }}</div>
      <div class="title">{{ t.title }}</div>
    </div>

    {% set _print_rows = seats_alpha if seats_alpha is defined else seats %}

    <div class="sk-print-columns">
      {% for r in _print_rows %}
        <div class="sk-print-line">
          <div class="sk-print-left">
            <strong>{{ r.nachname }}</strong>, {{ r.vorname }}
            <span class="sk-print-muted">· {{ r.wohnort }}</span>
            <span class="sk-print-muted"> (</span><span class="sk-print-pno">{{ r.player_no }}</span><span class="sk-print-muted">)</span>
          </div>
          <div class="sk-print-right sk-mono">
            {{ r.table_no }}/{{ r.seat }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

{% else %}
  <div class="alert alert-secondary d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="fw-semibold">Für Runde {{ round_no }} ist noch keine Auslosung vorhanden.</div>
      <div class="small text-muted mt-1">
        Tipp: <span class="fw-semibold">R</span> = auslosen ·
        <span class="fw-semibold">Shift+R</span> = auslosen ·
        <span class="fw-semibold">N</span>/<span class="fw-semibold">→</span> = Runde {{ round_no + 1 }} vorbereiten
        {% if is_closed %}
          <br><span class="fw-semibold text-danger">Hinweis:</span> Turnier ist abgeschlossen – Auslosen/Ändern gesperrt.
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <form method="post"
            action="{{ url_for('tournaments.tournament_round_draw', tournament_id=t.id, round_no=round_no) }}"
            class="d-inline"
            {% if not is_closed %}
            onsubmit="return confirm({{ ('Runde ' ~ round_no ~ ' auslosen?\n\nHinweis: Eine bestehende Auslosung dieser Runde wird überschrieben.')|tojson }});"
            {% endif %}>
        <button class="btn btn-warning" type="submit"
                {% if is_closed %}disabled aria-disabled="true"{% endif %}>
          Runde {{ round_no }} auslosen
        </button>
      </form>

      <a class="btn btn-outline-primary"
         id="btnPrepareNext2"
         href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=(round_no + 1)) }}">
        Runde {{ round_no + 1 }} vorbereiten
      </a>

      <a class="btn btn-outline-secondary"
         href="{{ url_for('tournaments.tournament_standings_overall', tournament_id=t.id) }}">
        Gesamtwertung
      </a>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  // Robust: nie Undefined in JSON serialisieren
  window.__SKT_ALLOW_DRAW_NEXT__ = {{ ((allow_draw_next|default(false)) and (not (is_closed|default(false))))|tojson }};
  window.__SKT_TOURNAMENT_CLOSED__ = {{ (is_closed|default(false))|tojson }};

  // ✅ NEU: Draw-Metadaten (immer definierter Wert: Zahl oder leerer String)
  window.__SKT_DRAW_ATTEMPT__ = {{ (_draw_attempt_int|default(0))|tojson }};
  window.__SKT_DRAW_SEED__ = {{ (_draw_seed_str|default(''))|tojson }};
</script>
<script defer src="{{ url_for('static', filename='js/round_keys.js') }}"></script>
{% endblock %}