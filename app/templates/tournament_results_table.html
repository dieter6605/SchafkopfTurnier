<!-- app/templates/tournament_results_table.html -->
{% extends "layout.html" %}
{% block content %}

<style>
  .sk-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .sk-sum-badge {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .25rem .5rem;
    border-radius: .5rem;
    font-weight: 600;
    border: 1px solid rgba(0,0,0,.15);
    background: rgba(0,0,0,.03);
  }
  .sk-sum-ok {
    border-color: rgba(25,135,84,.35);
    background: rgba(25,135,84,.08);
  }
  .sk-sum-bad {
    border-color: rgba(220,53,69,.35);
    background: rgba(220,53,69,.08);
  }
  .sk-help {
    font-size: .9rem;
    color: rgba(0,0,0,.6);
  }
</style>

{# robust: t kann obj oder mapping sein #}
{% set closed_at = (t.closed_at if t.closed_at is defined else (t['closed_at'] if (t is mapping and 'closed_at' in t) else None)) %}
{% set is_closed = (closed_at is not none and (closed_at|string)|trim|length > 0) %}
{% set _closed_at_str = ((closed_at|string)|trim) if is_closed else '' %}

<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
  <div>
    <h3 class="mb-0">{{ t.title }} – Runde {{ round_no }} – Tisch {{ table_no }}</h3>
    <div class="text-muted small">
      Punkte müssen in Summe <span class="fw-semibold">0</span> ergeben · Soli leer = 0
      {% if now %}· Stand: {{ now }}{% endif %}
    </div>
    <div class="sk-help mt-1">
      Tastatur: <span class="fw-semibold">Enter/↓</span> nächstes Feld · <span class="fw-semibold">↑</span> vorheriges Feld
      {% if is_closed %}
        <br><span class="fw-semibold text-danger">Hinweis:</span> Turnier ist abgeschlossen – Eingabe gesperrt (nur Ansicht).
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <a class="btn btn-outline-secondary"
       href="{{ url_for('tournaments.tournament_round_results_overview', tournament_id=t.id, round_no=round_no) }}">
      Tischübersicht
    </a>

    <a class="btn btn-outline-primary"
       href="{{ url_for('tournaments.tournament_round_results_standings', tournament_id=t.id, round_no=round_no) }}">
      Rundenwertung
    </a>

    <a class="btn btn-outline-secondary"
       href="{{ url_for('tournaments.tournament_standings_overall', tournament_id=t.id) }}">
      Gesamtwertung
    </a>

    {# ✅ NEU: Tischblatt (nur dieser Tisch) als DOCX #}
    <a class="btn btn-outline-secondary"
       href="{{ url_for('tournaments.tournament_round_tablesheet_docx_single',
                        tournament_id=t.id,
                        round_no=round_no,
                        table_no=table_no) }}">
      Tischblatt (DOCX)
    </a>

    {% if next_table %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('tournaments.tournament_round_results_table', tournament_id=t.id, round_no=round_no, table_no=next_table) }}">
        Nächster Tisch
      </a>
    {% endif %}
  </div>
</div>

{% if is_closed %}
  <div class="alert alert-warning d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="fw-semibold">Turnier ist abgeschlossen – Speichern ist deaktiviert.</div>
      <div class="small text-muted mt-1">Abgeschlossen seit: <span class="sk-mono">{{ closed_at }}</span></div>
    </div>
  </div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-body">

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div class="sk-sum-badge" id="skSumBadge" aria-live="polite">
        Summe Punkte: <span class="sk-mono" id="skSumValue">—</span>
        <span id="skSumState" class="small text-muted"></span>
      </div>
      <div class="text-muted small" id="skSumHint">
        Bitte alle 4 Punkte eingeben – danach muss die Summe <span class="fw-semibold">0</span> sein.
      </div>
    </div>

    <form method="post"
          id="skResultsForm"
          action="{{ url_for('tournaments.tournament_round_results_table', tournament_id=t.id, round_no=round_no, table_no=table_no) }}">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px;">Sitz</th>
              <th>Name</th>
              <th style="width:140px;">Punkte</th>
              <th style="width:140px;">Soli</th>
            </tr>
          </thead>
          <tbody>
            {% for p in players %}
              {% set tp_id = p.tp_id %}
              <tr>
                <td class="sk-mono fw-bold">{{ p.seat }}</td>
                <td>
                  <strong>{{ p.nachname }}</strong>, {{ p.vorname }}
                  <span class="text-muted">· {{ p.wohnort }}</span>
                  <span class="text-muted sk-mono"> (#{{ p.player_no }})</span>
                </td>
                <td>
                  <input class="form-control form-control-sm sk-points"
                         name="points_{{ tp_id }}"
                         value="{{ p.points if p.points is not none else '' }}"
                         inputmode="numeric"
                         autocomplete="off"
                         required
                         data-skt="points"
                         {% if is_closed %}disabled{% endif %}>
                </td>
                <td>
                  <input class="form-control form-control-sm sk-soli"
                         name="soli_{{ tp_id }}"
                         value="{{ p.soli if p.soli is not none else '' }}"
                         inputmode="numeric"
                         autocomplete="off"
                         placeholder="0"
                         data-skt="soli"
                         {% if is_closed %}disabled{% endif %}>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-3">
        <button class="btn btn-primary" id="btnSave" type="submit"
                {% if is_closed %}disabled{% endif %}>
          Speichern
        </button>

        <button class="btn btn-outline-primary"
                id="btnSaveNext"
                type="submit"
                name="go_next"
                value="1"
                {% if is_closed %}disabled{% endif %}>
          Speichern & nächster Tisch
        </button>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('tournaments.tournament_round_view', tournament_id=t.id, round_no=round_no) }}">
          Zurück zur Runde
        </a>
      </div>
    </form>

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function() {
  const IS_CLOSED = {{ (true if (is_closed|default(false)) else false)|tojson }};

  const form = document.getElementById("skResultsForm");
  if (!form) return;

  const pointsInputs = Array.from(document.querySelectorAll("input.sk-points"));
  const soliInputs = Array.from(document.querySelectorAll("input.sk-soli"));
  const allInputs = Array.from(document.querySelectorAll("#skResultsForm input[data-skt]"));

  const badge = document.getElementById("skSumBadge");
  const sumValueEl = document.getElementById("skSumValue");
  const sumStateEl = document.getElementById("skSumState");
  const sumHintEl = document.getElementById("skSumHint");

  const btnSave = document.getElementById("btnSave");
  const btnSaveNext = document.getElementById("btnSaveNext");

  function parseIntLoose(v) {
    if (v == null) return null;
    const s = String(v).trim();
    if (s === "") return null;
    if (!/^[+-]?\d+$/.test(s)) return NaN;
    return parseInt(s, 10);
  }

  function updateSumUI() {
    if (IS_CLOSED) {
      let total = 0;
      let filled = 0;
      let hasInvalid = false;

      for (const inp of pointsInputs) {
        const n = parseIntLoose(inp.value);
        if (n === null) continue;
        if (Number.isNaN(n)) { hasInvalid = true; continue; }
        filled += 1;
        total += n;
      }

      if (filled === 0 && !hasInvalid) {
        sumValueEl.textContent = "—";
        sumStateEl.textContent = "";
      } else if (hasInvalid) {
        sumValueEl.textContent = "!";
        sumStateEl.textContent = " (ungültig)";
      } else {
        sumValueEl.textContent = String(total);
        sumStateEl.textContent = "";
      }

      badge?.classList.remove("sk-sum-ok", "sk-sum-bad");
      if (sumHintEl) sumHintEl.textContent = "Turnier abgeschlossen – Eingabe ist gesperrt (nur Ansicht).";
      if (btnSave) btnSave.disabled = true;
      if (btnSaveNext) btnSaveNext.disabled = true;
      return;
    }

    let total = 0;
    let filled = 0;
    let hasInvalid = false;

    for (const inp of pointsInputs) {
      const n = parseIntLoose(inp.value);
      inp.classList.remove("is-invalid", "is-valid");

      if (n === null) continue;

      if (Number.isNaN(n)) {
        hasInvalid = true;
        inp.classList.add("is-invalid");
        continue;
      }

      filled += 1;
      total += n;
      inp.classList.add("is-valid");
    }

    if (filled === 0 && !hasInvalid) {
      sumValueEl.textContent = "—";
      sumStateEl.textContent = "";
      badge?.classList.remove("sk-sum-ok", "sk-sum-bad");
      if (sumHintEl) sumHintEl.textContent = "Bitte alle 4 Punkte eingeben – danach muss die Summe 0 sein.";
      if (btnSave) btnSave.disabled = true;
      if (btnSaveNext) btnSaveNext.disabled = true;
      return;
    }

    if (hasInvalid) {
      sumValueEl.textContent = "!";
      sumStateEl.textContent = " Ungültige Eingabe";
      badge?.classList.add("sk-sum-bad");
      badge?.classList.remove("sk-sum-ok");
      if (sumHintEl) sumHintEl.textContent = "Nur ganze Zahlen bei Punkte zulässig (z.B. 12, -8).";
      if (btnSave) btnSave.disabled = true;
      if (btnSaveNext) btnSaveNext.disabled = true;
      return;
    }

    sumValueEl.textContent = String(total);

    const ready = (filled === 4);

    if (!ready) {
      sumStateEl.textContent = " (noch nicht komplett)";
      badge?.classList.remove("sk-sum-ok");
      badge?.classList.add("sk-sum-bad");
      if (sumHintEl) sumHintEl.textContent = "Bitte alle 4 Punktefelder ausfüllen.";
      if (btnSave) btnSave.disabled = true;
      if (btnSaveNext) btnSaveNext.disabled = true;
      return;
    }

    if (total === 0) {
      sumStateEl.textContent = " ✓";
      badge?.classList.add("sk-sum-ok");
      badge?.classList.remove("sk-sum-bad");
      if (sumHintEl) sumHintEl.textContent = "OK – Summe ist 0. Du kannst speichern.";
      if (btnSave) btnSave.disabled = false;
      if (btnSaveNext) btnSaveNext.disabled = false;
    } else {
      sumStateEl.textContent = " ✗";
      badge?.classList.remove("sk-sum-ok");
      badge?.classList.add("sk-sum-bad");
      if (sumHintEl) sumHintEl.textContent = `Fehler: Summe ist ${total} (muss 0 sein). Eingaben bleiben erhalten.`;
      if (btnSave) btnSave.disabled = true;
      if (btnSaveNext) btnSaveNext.disabled = true;
    }
  }

  function moveFocus(cur, dir) {
    const idx = allInputs.indexOf(cur);
    if (idx === -1) return;
    const next = allInputs[idx + dir];
    if (next) {
      next.focus();
      next.select?.();
    }
  }

  function onKeyDown(e) {
    const target = e.target;
    if (!(target instanceof HTMLInputElement)) return;

    if (e.key === "Enter") { e.preventDefault(); moveFocus(target, +1); return; }
    if (e.key === "ArrowDown") { e.preventDefault(); moveFocus(target, +1); return; }
    if (e.key === "ArrowUp") { e.preventDefault(); moveFocus(target, -1); return; }
  }

  for (const inp of pointsInputs) {
    inp.addEventListener("input", updateSumUI);
    inp.addEventListener("change", updateSumUI);
    inp.addEventListener("keydown", onKeyDown);
  }
  for (const inp of soliInputs) {
    inp.addEventListener("keydown", onKeyDown);
  }

  updateSumUI();

  form.addEventListener("submit", function(e) {
    if (IS_CLOSED) { e.preventDefault(); return; }
    updateSumUI();
    if (btnSave && btnSave.disabled) {
      e.preventDefault();
      const bad = document.querySelector("input.sk-points.is-invalid") || pointsInputs[0];
      if (bad) { bad.focus(); bad.select?.(); }
    }
  });
})();
</script>
{% endblock %}